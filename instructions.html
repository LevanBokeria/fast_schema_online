<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0">
	<title>Instructions</title>
	<script src="jspsych-6.3.1/jspsych.js"></script>
	<script src='./jspsych-6.3.1/plugins/jspsych-instructions.js'></script>
	<script src='./jspsych-6.3.1/plugins/jspsych-html-slider-response.js'></script>
	<script src='./jspsych-6.3.1/plugins/jspsych-survey-multi-choice.js'></script>
	<script src='./jspsych-6.3.1/plugins/jspsych-preload.js'></script>
	<script src='./extra_functions/board_creator.js'></script>
	<script src="jatos.js"></script>
	<link rel="stylesheet" href="jspsych-6.3.1/css/jspsych.css" type="text/css">
	</link>
	<link rel="stylesheet" href="./extra_files/schema_online.css" type="text/css">
	</link>
</head>

<body>
	<script>
		
		//start timeline
		jatos.onLoad(function () {
			debugger
			//make a timeline
			let timeline = [];
			let grid_size = 300
			// Create the board element for instructions
			// Create the board

			var curr_trial = jatos.studySessionData.inputData.all_blocks[1][0]

			var grid_border = board_creator(
				grid_size,
				jatos.studySessionData.inputData.n_rows,
				jatos.studySessionData.inputData.n_cols,
				true,
				false,
				curr_trial
			)

			// Remove certain styles:
			grid_border.children[0].style.removeProperty('transform')
			grid_border.children[0].style.removeProperty('top')
			grid_border.children[0].style.removeProperty('left')
			grid_border.children[0].style.position = 'relative'
			grid_border.children[0].style.margin = 'auto'

			// Create a flexbox with the hidden pictures
			var flex_hidden_pics_el = document.createElement('div')

			flex_hidden_pics_el.display = 'flex'

			for (iPA = 0; iPA < curr_trial.new_pa_all_imgs.length; iPA++) {

				let nPA = document.createElement('img')

				nPA.src = curr_trial.new_pa_all_imgs[iPA]

				nPA.style.height = '50px'
				nPA.style.border = '1px solid black'
				nPA.style.margin = '0px 2px 0px'

				flex_hidden_pics_el.appendChild(nPA)
			}

			////////////////////////////////////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////////////////////////////////////
			// Create a flexbox to put the stages of the trial
			////////////////////////////////////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////////////////////////////////////
			var grid_trial_1_stages_el = document.createElement('div')

			grid_trial_1_stages_el.style =
				'display: grid;' +
				'grid-template-columns: 2fr 1fr 2fr 2fr;' +
				'grid-template-rows: auto;' +
				'position: relative;'

			let small_grid_size = '150px'

			var grid_border_small = grid_border.cloneNode(true)
			grid_border_small.children[0].style.height = small_grid_size
			grid_border_small.children[0].style.width = small_grid_size

			// Create the empty purple board
			var grid_border_empty = board_creator(
				small_grid_size,
				jatos.studySessionData.inputData.n_rows,
				jatos.studySessionData.inputData.n_cols,
				false,
				false,
				curr_trial
			)

			// Remove certain styles:
			grid_border_empty.children[0].style.removeProperty('transform')
			grid_border_empty.children[0].style.removeProperty('top')
			grid_border_empty.children[0].style.removeProperty('left')
			grid_border_empty.children[0].style.position = 'relative'
			grid_border_empty.children[0].style.margin = 'auto'
			grid_border_empty.children[0].style.height = small_grid_size
			grid_border_empty.children[0].style.width = small_grid_size

			// Create the board with visible and 1 hidden item
			var grid_border_fb = board_creator(
				small_grid_size,
				jatos.studySessionData.inputData.n_rows,
				jatos.studySessionData.inputData.n_cols,
				true,
				false,
				curr_trial
			)
			// debugger
			// Remove certain styles:
			grid_border_fb.children[0].style.removeProperty('transform')
			grid_border_fb.children[0].style.removeProperty('top')
			grid_border_fb.children[0].style.removeProperty('left')
			grid_border_fb.children[0].style.position = 'relative'
			grid_border_fb.children[0].style.margin = 'auto'
			grid_border_fb.children[0].style.height = small_grid_size
			grid_border_fb.children[0].style.width = small_grid_size

			grid_border_fb.children[0].querySelector('#newPA_1').style.visibility = 'visible'

			grid_trial_1_stages_el.innerHTML += '<div>Step 1:</div>'
			grid_trial_1_stages_el.innerHTML += '<div>Step 2:</div>'
			grid_trial_1_stages_el.innerHTML += '<div>Step 3:</div>'
			grid_trial_1_stages_el.innerHTML += '<div>Step 4:</div>'
			grid_trial_1_stages_el.innerHTML += '<div>Board + visible items</div>'
			grid_trial_1_stages_el.innerHTML += '<div>Hidden item to find</div>'
			grid_trial_1_stages_el.innerHTML += '<div>Make your response</div>'
			grid_trial_1_stages_el.innerHTML += '<div>Feedback</div>'
			grid_trial_1_stages_el.innerHTML += grid_border_small.innerHTML
			grid_trial_1_stages_el.innerHTML += '<img src="' + curr_trial.new_pa_all_imgs[0] + '" alt="example_prompt" style="height:100px; margin-left:auto; margin-right:auto;"></img>'
			grid_trial_1_stages_el.innerHTML += grid_border_empty.innerHTML
			grid_trial_1_stages_el.innerHTML += grid_border_fb.innerHTML

			// Create the board with moved items
            var next_trial = jatos.studySessionData.inputData.all_blocks[1][1]

			var grid_border_moved_items = board_creator(
				grid_size,
				jatos.studySessionData.inputData.n_rows,
				jatos.studySessionData.inputData.n_cols,
				true,
				false,
				next_trial
			)

			// Remove certain styles:
			grid_border_moved_items.children[0].style.removeProperty('transform')
			grid_border_moved_items.children[0].style.removeProperty('top')
			grid_border_moved_items.children[0].style.removeProperty('left')
			grid_border_moved_items.children[0].style.position = 'relative'
			grid_border_moved_items.children[0].style.margin = 'auto'


			////////////////////////////////////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////////////////////////////////////
			// Create a flexbox to put the stages of the trial
			////////////////////////////////////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////////////////////////////////////
			var grid_trial_2_stages_el = document.createElement('div')

			grid_trial_2_stages_el.style =
				'display: grid;' +
				'grid-template-columns: 2fr 1fr 2fr 2fr;' +
				'grid-template-rows: auto;' +
				'position: relative;'

			var grid_border_small_moved_items = grid_border_moved_items.cloneNode(true)
			grid_border_small_moved_items.children[0].style.height = small_grid_size
			grid_border_small_moved_items.children[0].style.width = small_grid_size

			// Create the board with visible and 1 hidden item
			var grid_border_fb_moved_items = board_creator(
				small_grid_size,
				jatos.studySessionData.inputData.n_rows,
				jatos.studySessionData.inputData.n_cols,
				true,
				false,
				next_trial
			)
			
			// Remove certain styles:
			grid_border_fb_moved_items.children[0].style.removeProperty('transform')
			grid_border_fb_moved_items.children[0].style.removeProperty('top')
			grid_border_fb_moved_items.children[0].style.removeProperty('left')
			grid_border_fb_moved_items.children[0].style.position = 'relative'
			grid_border_fb_moved_items.children[0].style.margin = 'auto'
			grid_border_fb_moved_items.children[0].style.height = small_grid_size
			grid_border_fb_moved_items.children[0].style.width = small_grid_size

			grid_border_fb_moved_items.children[0].querySelector('#newPA_1').style.visibility = 'visible'

			grid_trial_2_stages_el.innerHTML += '<div>Step 1:</div>'
			grid_trial_2_stages_el.innerHTML += '<div>Step 2:</div>'
			grid_trial_2_stages_el.innerHTML += '<div>Step 3:</div>'
			grid_trial_2_stages_el.innerHTML += '<div>Step 4:</div>'
			grid_trial_2_stages_el.innerHTML += '<div>Board + visible items</div>'
			grid_trial_2_stages_el.innerHTML += '<div>Hidden item to find</div>'
			grid_trial_2_stages_el.innerHTML += '<div>Make your response</div>'
			grid_trial_2_stages_el.innerHTML += '<div>Feedback</div>'
			grid_trial_2_stages_el.innerHTML += grid_border_small_moved_items.innerHTML
			grid_trial_2_stages_el.innerHTML += '<img src="' + next_trial.new_pa_all_imgs[0] + '" alt="example_prompt" style="height:100px; margin-left:auto; margin-right:auto;"></img>'
			grid_trial_2_stages_el.innerHTML += grid_border_empty.innerHTML
			grid_trial_2_stages_el.innerHTML += grid_border_fb_moved_items.innerHTML


			// Define pages for phase 1
			let instruction_pages = [
				'<div class= "header">' +
				'<h1> Practice part 2 </h1>' +
				'</div>' +
				'<div class="instruct">' +
				'<p>In the real experiment, you will have to find hidden pictures on 5 differently colored boards.</p>' +
                '<br>' +
                '<p>On some of these boards, the visible items will always stay fixed inside the board, like you saw for the purple board.</p>' +
                '<p><b>However, for some other boards, the visible items might change their locations!</b></p>' +
                '<p>Some of the visible items might stay fixed, while others might move. Some might swap places with another visible items.</p>' +
				'<p>Click "Next" to see an example!</p>',

				'<h1> Practice part 2 </h1>' +
				'</div>' +
				'<div class="instruct">' +
				'<p>For example, on one trial, this pink board will be shown with its visible items like this: </p>' + grid_border.innerHTML +
				'<p><br>Your task is still to find the hidden items on the board.</p>' +
				'<p><b>Hidden pictures:</b></p>' +
				flex_hidden_pics_el.innerHTML +
				'<p><br><b>Example trial 1:</b></p>' +
				grid_trial_1_stages_el.outerHTML + 
				'</div>',

				'<div class= "header">' +
				'<h1> Practice part 2 </h1>' +
				'</div>' +
				'<div class="instruct">' +

				'<p>But on the next trial, the visible items might have moved, like this:</p>' + grid_border_moved_items.innerHTML +
				'<p><br>You can see that <b>two</b> of the visible items stayed in the same location, while all the others moved.</p>' +
				'<p>Your task is still to find the same hidden items on the board. These will never change their locations.</p>' +
				'<p><b>Hidden pictures:</b></p>' +
				flex_hidden_pics_el.innerHTML +
				'<p><br><b>Example trial 2:</b></p>' +
				grid_trial_2_stages_el.outerHTML + 
				'</div>',

				'<div class= "header">' +
				'<h1> Practice part 2 </h1>' +
				'</div>' +
				'<div class="instruct">' +
				'<p>Remember, during the real experiment, you might get a board where some or all the visible items switch locations, or where the visible items swap places with each other!</p>' +
				'<p><br>And remember, your task is always just to find the hidden items, which will never change locations!</p>' +
                '<br>' +
				'<p>Click next to do a few practice trials with this pink board where 2 of the visible items stay fixed while others move!</p>' +
				'</div>'
			];

			let instructions = {
				type: 'instructions',
				pages: instruction_pages,
				show_clickable_nav: true,
				button_label_next: '<span style="color: black"d;> <strong> Next </stong></span>',
			};

			// Preload
			var preload = {
				type: 'preload',
				images: [
					...jatos.studySessionData.inputData.all_images.practice,
					...jatos.studySessionData.inputData.all_images.practice2,
					...jatos.studySessionData.inputData.all_images.cond1,
					...jatos.studySessionData.inputData.all_images.cond2,
					...jatos.studySessionData.inputData.all_images.cond3,
					...jatos.studySessionData.inputData.all_images.cond4,
					...jatos.studySessionData.inputData.all_images.cond5,
				]
			}
			timeline.push(preload);

			timeline.push(instructions);


			jsPsych.init({
				timeline: timeline,

				on_finish: function (data) {

					// Make JATOS remember that this block was run
					jatos.studySessionData.latestFinishedComponentId    = jatos.componentId;
					jatos.studySessionData.latestFinishedComponentPos   = jatos.componentPos;
					jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;
					debugger
					// Record results
					jatos.studySessionData.outputData.instructions_results = jsPsych.data.get().values()[0];

					let comp_to_start = jatos.studySessionData.inputData.component_positions.block_pa

					jatos.submitResultData('[instructions_start---' +
						JSON.stringify(jatos.studySessionData) +
						'---instructions_end]',
						function () { jatos.startComponentByPos(comp_to_start) });

				}
			})


		});


	</script>
</body>

</html>